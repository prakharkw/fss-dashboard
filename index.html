<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSS Empty Mileage Deviation Metrics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #ffffff;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 25px;
            margin-bottom: 25px;
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            color: #ffffff;
            font-size: 2.2em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }

        .header h1 span { color: #3498db; }
        .header p { color: #8892b0; font-size: 0.95em; }

        .loading {
            text-align: center;
            padding: 50px;
            color: #3498db;
            font-size: 1.2em;
        }

        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: linear-gradient(145deg, #1e3a5f, #0d2137);
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-card.blue { border-top: 3px solid #3498db; }
        .kpi-card.green { border-top: 3px solid #2ecc71; }
        .kpi-card.orange { border-top: 3px solid #f39c12; }
        .kpi-card.purple { border-top: 3px solid #9b59b6; }
        .kpi-card.cyan { border-top: 3px solid #00cec9; }
        .kpi-card.red { border-top: 3px solid #e74c3c; }

        .kpi-label {
            color: #8892b0;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .kpi-value { font-size: 1.8em; font-weight: 700; }
        .kpi-card.blue .kpi-value { color: #3498db; }
        .kpi-card.green .kpi-value { color: #2ecc71; }
        .kpi-card.orange .kpi-value { color: #f39c12; }
        .kpi-card.purple .kpi-value { color: #9b59b6; }
        .kpi-card.cyan .kpi-value { color: #00cec9; }
        .kpi-card.red .kpi-value { color: #e74c3c; }

        .filter-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .filter-section-title {
            color: #3498db;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .filter-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            color: #8892b0;
            font-size: 0.85em;
            white-space: nowrap;
        }

        .filter-group select,
        .filter-group input[type="date"] {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: #1a1a2e;
            color: #ffffff;
            font-size: 0.85em;
            cursor: pointer;
            min-width: 140px;
        }

        .filter-group select:focus,
        .filter-group input[type="date"]:focus {
            outline: none;
            border-color: #3498db;
        }

        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .filter-btn.primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .filter-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #8892b0;
        }

        .filter-btn:hover { transform: translateY(-2px); }

        .section-header {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
            padding: 15px 25px;
            border-radius: 12px 12px 0 0;
            font-size: 1.1em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 30px;
        }

        .section-content {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 25px;
        }

        .tables-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 35px;
        }

        .tables-row:last-child {
            margin-bottom: 0;
        }

        .table-card {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .table-header {
            background: linear-gradient(90deg, rgba(46, 204, 113, 0.4), rgba(39, 174, 96, 0.4));
            color: #2ecc71;
            padding: 15px 18px;
            font-weight: 700;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid rgba(46, 204, 113, 0.5);
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 350px;
            overflow-y: auto;
        }

        .table-card table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .table-card th {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
            padding: 12px 15px;
            text-align: left;
            font-size: 0.8em;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .table-card td {
            padding: 10px 12px;
            color: #e0e0e0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            white-space: nowrap;
        }

        .table-card tr:hover td { background: rgba(52, 152, 219, 0.08); }

        .table-card .total-row td {
            background: rgba(52, 152, 219, 0.2) !important;
            font-weight: 700;
            color: #3498db !important;
            border-top: 2px solid rgba(52, 152, 219, 0.3);
        }

        .table-card .blank-row td {
            color: #888 !important;
            font-style: italic;
        }

        .footer {
            text-align: center;
            padding: 25px;
            color: #8892b0;
            margin-top: 30px;
            font-size: 0.85em;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .data-count {
            background: #2ecc71;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 10px;
        }

        .data-source {
            background: #9b59b6;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 10px;
        }

        .date-range-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .date-range-group span {
            color: #8892b0;
            font-size: 0.85em;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-left: auto;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 1400px) {
            .kpi-container { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 1000px) {
            .kpi-container { grid-template-columns: repeat(2, 1fr); }
            .tables-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 600px) {
            .kpi-container { grid-template-columns: 1fr; }
            .filter-row { flex-direction: column; align-items: stretch; }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(52, 152, 219, 0.5); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üöö <span>FSS</span> Empty Mileage Deviation Metrics</h1>
            <p>Deviation Tracking & Analysis | Last Updated: <span id="lastUpdated"></span> <span class="data-count" id="dataCount">Loading...</span> <span class="data-source">üìä GitHub Data</span></p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading data from GitHub...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-message" style="display: none;">
            <p>‚ö†Ô∏è Unable to load data. Please check your internet connection.</p>
            <button onclick="loadData()" class="filter-btn primary" style="margin-top: 10px;">Retry</button>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none;">
            <div class="kpi-container">
                <div class="kpi-card blue">
                    <div class="kpi-label">Total Cases</div>
                    <div class="kpi-value" id="kpiTotalCases">0</div>
                </div>
                <div class="kpi-card green">
                    <div class="kpi-label">Total Cost Saved</div>
                    <div class="kpi-value" id="kpiCostSaved">$0</div>
                </div>
                <div class="kpi-card orange">
                    <div class="kpi-label">Total Miles Saved</div>
                    <div class="kpi-value" id="kpiMilesSaved">0</div>
                </div>
                <div class="kpi-card purple">
                    <div class="kpi-label">Avg SL (Min)</div>
                    <div class="kpi-value" id="kpiAvgSL">0</div>
                </div>
                <div class="kpi-card cyan">
                    <div class="kpi-label">Tour Modified</div>
                    <div class="kpi-value" id="kpiTourModified">0</div>
                </div>
                <div class="kpi-card red">
                    <div class="kpi-label">Tour Modified %</div>
                    <div class="kpi-value" id="kpiTourModifiedPct">0%</div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-section-title">üîç Filters & Controls</div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Shift:</label>
                        <select id="filterShift"><option value="all">All Shifts</option></select>
                    </div>
                    <div class="filter-group">
                        <label>Action:</label>
                        <select id="filterAction">
                            <option value="all">All Actions</option>
                            <option value="Tour Modified">Tour Modified</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Month:</label>
                        <select id="filterMonth"><option value="all">All Months</option></select>
                    </div>
                    <div class="filter-group">
                        <label>Week:</label>
                        <select id="filterWeek"><option value="all">All Weeks</option></select>
                    </div>
                    <div class="filter-group date-range-group">
                        <label>Date Range:</label>
                        <input type="date" id="filterStartDate" title="Start Date">
                        <span>to</span>
                        <input type="date" id="filterEndDate" title="End Date">
                    </div>
                    <button class="filter-btn primary" onclick="applyFilters()">Apply</button>
                    <button class="filter-btn secondary" onclick="resetFilters()">Reset</button>
                    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
                </div>
            </div>

            <div class="section-header">üìä Analysis Tables</div>
            <div class="section-content">
                <div class="tables-row">
                    <div class="table-card">
                        <div class="table-header">üí∞ Cost Saved by Shipper Size (Monthly)</div>
                        <div class="table-wrapper"><table id="tableShipperMonthly"><thead></thead><tbody></tbody></table></div>
                    </div>
                    <div class="table-card">
                        <div class="table-header">üí∞ Cost Saved by Shipper Size (Weekly)</div>
                        <div class="table-wrapper"><table id="tableShipperWeekly"><thead></thead><tbody></tbody></table></div>
                    </div>
                </div>
                <div class="tables-row">
                    <div class="table-card">
                        <div class="table-header">üí∞ Cost Saved by Program Type (Monthly)</div>
                        <div class="table-wrapper"><table id="tableProgramMonthly"><thead></thead><tbody></tbody></table></div>
                    </div>
                    <div class="table-card">
                        <div class="table-header">üìä Count by Program Type (Weekly)</div>
                        <div class="table-wrapper"><table id="tableProgramWeekly"><thead></thead><tbody></tbody></table></div>
                    </div>
                </div>
                <div class="tables-row">
                    <div class="table-card">
                        <div class="table-header">üìä Deviation Count by Shift (Monthly)</div>
                        <div class="table-wrapper"><table id="tableShiftMonthly"><thead></thead><tbody></tbody></table></div>
                    </div>
                    <div class="table-card">
                        <div class="table-header">üìä Deviation Count by Shift (Weekly)</div>
                        <div class="table-wrapper"><table id="tableShiftWeekly"><thead></thead><tbody></tbody></table></div>
                    </div>
                </div>
                <div class="tables-row">
                    <div class="table-card">
                        <div class="table-header">‚è±Ô∏è Avg SL by Associate - Monthly (Minutes)</div>
                        <div class="table-wrapper"><table id="tableSLMonthly"><thead></thead><tbody></tbody></table></div>
                    </div>
                    <div class="table-card">
                        <div class="table-header">‚è±Ô∏è Avg SL by Associate - Weekly (Minutes)</div>
                        <div class="table-wrapper"><table id="tableSLWeekly"><thead></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>

            <div class="section-header">üìà Associate Performance (Last 4 Periods)</div>
            <div class="section-content">
                <div class="tables-row">
                    <div class="table-card">
                        <div class="table-header">üìä Cases Count - Last 4 Weeks</div>
                        <div class="table-wrapper"><table id="tableCountWeeks"><thead></thead><tbody></tbody></table></div>
                    </div>
                    <div class="table-card">
                        <div class="table-header">üìä Cases Count - Last 4 Months</div>
                        <div class="table-wrapper"><table id="tableCountMonths"><thead></thead><tbody></tbody></table></div>
                    </div>
                </div>
                <div class="tables-row">
                    <div class="table-card">
                        <div class="table-header">üí∞ Cost Saved - Last 4 Weeks</div>
                        <div class="table-wrapper"><table id="tableCostWeeks"><thead></thead><tbody></tbody></table></div>
                    </div>
                    <div class="table-card">
                        <div class="table-header">üí∞ Cost Saved - Last 4 Months</div>
                        <div class="table-wrapper"><table id="tableCostMonths"><thead></thead><tbody></tbody></table></div>
                    </div>
                </div>
                <div class="tables-row">
                    <div class="table-card">
                        <div class="table-header">üõ£Ô∏è Miles Saved - Last 4 Weeks</div>
                        <div class="table-wrapper"><table id="tableMilesWeeks"><thead></thead><tbody></tbody></table></div>
                    </div>
                    <div class="table-card">
                        <div class="table-header">üõ£Ô∏è Miles Saved - Last 4 Months</div>
                        <div class="table-wrapper"><table id="tableMilesMonths"><thead></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            FSS Operations Team | Data Source: GitHub | Dashboard v3.0<br>
            <small>üí° Data updates when CSV file is updated on GitHub</small>
        </div>
    </div>

    <script>
    // =====================================================
    // üî¥ YOUR GITHUB CSV URL
    // =====================================================
    
    const GITHUB_CSV_URL = 'https://raw.githubusercontent.com/prakharkw/fss-dashboard/refs/heads/main/Data.csv';
    
    // =====================================================

    let rawData = [];
    let monthNames = {};

    // Load data from GitHub
    async function loadData() {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('errorState').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'none';

        try {
            // Add cache-busting parameter to get fresh data
            const url = GITHUB_CSV_URL + '?t=' + new Date().getTime();
            const response = await fetch(url);
            
            if (!response.ok) throw new Error('Failed to fetch data');
            
            const csvText = await response.text();
            rawData = parseCSV(csvText);
            
            console.log('Loaded records:', rawData.length);
            console.log('Sample record:', rawData[0]);

            if (rawData.length === 0) {
                throw new Error('No data found');
            }

            // Build month names mapping
            rawData.forEach(d => {
                if (d.month && d.month_name) {
                    monthNames[d.month] = d.month_name;
                }
            });

            // Hide loading, show dashboard
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            // Initialize dashboard
            populateFilters();
            setDefaultDateRange();
            updateDashboard();

            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString('en-IN', {
                day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            document.getElementById('dataCount').textContent = rawData.length + ' records';

        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        }
    }

    // Parse CSV data
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length < 2) return [];

        const headers = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase().replace(/\s+/g, '_'));
        const data = [];

        for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            const row = {};
            
            headers.forEach((header, index) => {
                let value = values[index] ? values[index].trim() : '';
                
                if (['week', 'month', 'year', 'sl'].includes(header)) {
                    row[header] = parseInt(value) || 0;
                } else if (['miles_saved', 'cost_saved'].includes(header)) {
                    row[header] = parseFloat(value) || 0;
                } else {
                    row[header] = value;
                }
            });

            if (row.detection_ist) {
                row.detection_date = row.detection_ist.split(' ')[0];
            }

            data.push(row);
        }

        return data;
    }

    // Parse CSV line (handles quoted values)
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current);

        return result.map(val => val.replace(/^"|"$/g, ''));
    }

    function populateFilters() {
        const shifts = [...new Set(rawData.map(d => d.shift).filter(s => s))].sort();
        const shiftSelect = document.getElementById('filterShift');
        shiftSelect.innerHTML = '<option value="all">All Shifts</option>';
        shifts.forEach(s => shiftSelect.innerHTML += `<option value="${s}">${s}</option>`);

        const months = [...new Set(rawData.map(d => d.month).filter(m => m))].sort((a,b) => a-b);
        const monthSelect = document.getElementById('filterMonth');
        monthSelect.innerHTML = '<option value="all">All Months</option>';
        months.forEach(m => {
            const name = monthNames[m] || `Month ${m}`;
            monthSelect.innerHTML += `<option value="${m}">${name}</option>`;
        });

        const weeks = [...new Set(rawData.map(d => d.week).filter(w => w))].sort((a,b) => a-b);
        const weekSelect = document.getElementById('filterWeek');
        weekSelect.innerHTML = '<option value="all">All Weeks</option>';
        weeks.forEach(w => weekSelect.innerHTML += `<option value="${w}">W${w}</option>`);
    }

    function setDefaultDateRange() {
        const dates = rawData.map(d => d.detection_date).filter(d => d).sort();
        if (dates.length > 0) {
            document.getElementById('filterStartDate').value = dates[0];
            document.getElementById('filterEndDate').value = dates[dates.length - 1];
        }
    }

    function getFilteredData(type = 'all') {
        const shift = document.getElementById('filterShift').value;
        const action = document.getElementById('filterAction').value;
        const month = document.getElementById('filterMonth').value;
        const week = document.getElementById('filterWeek').value;
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;

        return rawData.filter(d => {
            if (startDate && d.detection_date && d.detection_date < startDate) return false;
            if (endDate && d.detection_date && d.detection_date > endDate) return false;
            if (shift !== 'all' && d.shift !== shift) return false;
            if (action !== 'all' && d.action !== action) return false;
            if (type === 'monthly' && month !== 'all' && d.month !== parseInt(month)) return false;
            if (type === 'weekly' && week !== 'all' && d.week !== parseInt(week)) return false;
            return true;
        });
    }

    function getLast4Data(type) {
        const shift = document.getElementById('filterShift').value;
        const action = document.getElementById('filterAction').value;
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;

        let filtered = rawData.filter(d => {
            if (startDate && d.detection_date && d.detection_date < startDate) return false;
            if (endDate && d.detection_date && d.detection_date > endDate) return false;
            if (shift !== 'all' && d.shift !== shift) return false;
            if (action !== 'all' && d.action !== action) return false;
            return true;
        });

        if (type === 'weeks') {
            const last4 = [...new Set(filtered.map(d => d.week))].sort((a,b) => b-a).slice(0, 4);
            return filtered.filter(d => last4.includes(d.week));
        } else {
            const last4 = [...new Set(filtered.map(d => d.month))].sort((a,b) => b-a).slice(0, 4);
            return filtered.filter(d => last4.includes(d.month));
        }
    }

    function applyFilters() { updateDashboard(); }

    function resetFilters() {
        document.getElementById('filterShift').value = 'all';
        document.getElementById('filterAction').value = 'all';
        document.getElementById('filterMonth').value = 'all';
        document.getElementById('filterWeek').value = 'all';
        setDefaultDateRange();
        updateDashboard();
    }

    function updateDashboard() {
        updateKPIs();
        updateAllTables();
    }

    function formatWithKL(num) {
        if (num === 0 || !num) return '0';
        if (num >= 100000) {
            return (num / 100000).toFixed(2) + 'L';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return Math.round(num).toLocaleString('en-IN');
    }

    function updateKPIs() {
        const data = getFilteredData('all');

        const total = data.length;
        const cost = data.reduce((s, d) => s + (d.cost_saved || 0), 0);
        const miles = data.reduce((s, d) => s + (d.miles_saved || 0), 0);
        const avgSL = total > 0 ? data.reduce((s, d) => s + (d.sl || 0), 0) / total : 0;
        const tourMod = data.filter(d => d.action === 'Tour Modified').length;
        const tourPct = total > 0 ? (tourMod / total * 100) : 0;

        document.getElementById('kpiTotalCases').textContent = total.toLocaleString('en-IN');
        document.getElementById('kpiCostSaved').textContent = '$' + formatWithKL(cost);
        document.getElementById('kpiMilesSaved').textContent = formatWithKL(miles);
        document.getElementById('kpiAvgSL').textContent = Math.round(avgSL);
        document.getElementById('kpiTourModified').textContent = tourMod.toLocaleString('en-IN');
        document.getElementById('kpiTourModifiedPct').textContent = tourPct.toFixed(1) + '%';
    }

    function pivot(data, rowKey, colKey, valKey, aggType) {
        let rows = [...new Set(data.map(d => d[rowKey] || '(Blank)'))];
        const cols = [...new Set(data.map(d => d[colKey]))].sort((a,b) => a-b);

        rows = rows.sort((a, b) => {
            if (a === '(Blank)') return 1;
            if (b === '(Blank)') return -1;
            return a.localeCompare(b);
        });

        const result = {};
        const colTotals = {};

        rows.forEach(r => { result[r] = {}; cols.forEach(c => result[r][c] = {sum: 0, count: 0}); });
        cols.forEach(c => colTotals[c] = {sum: 0, count: 0});

        data.forEach(d => {
            const r = d[rowKey] || '(Blank)';
            const c = d[colKey];
            const v = parseFloat(d[valKey]) || 0;
            if (result[r] && result[r][c]) {
                result[r][c].sum += v;
                result[r][c].count += 1;
                colTotals[c].sum += v;
                colTotals[c].count += 1;
            }
        });

        return {result, rows, cols, colTotals, aggType};
    }

    function renderTable(tableId, pivotData, colPrefix, valFormat, rowLabel) {
        const {result, rows, cols, colTotals, aggType} = pivotData;
        const table = document.getElementById(tableId);

        let header = `<tr><th>${rowLabel}</th>`;
        cols.forEach(c => {
            const label = colPrefix === 'W' ? `W${c}` : (monthNames[c] || `M${c}`);
            header += `<th>${label}</th>`;
        });
        header += `<th>Total</th></tr>`;
        table.querySelector('thead').innerHTML = header;

        let body = '';
        let grandSum = 0, grandCount = 0;

        if (rows.length === 0) {
            body = `<tr><td colspan="${cols.length + 2}" style="text-align:center;color:#666;">No data</td></tr>`;
        } else {
            rows.forEach(r => {
                let rowSum = 0, rowCount = 0;
                const isBlank = r === '(Blank)';
                const rowClass = isBlank ? 'blank-row' : '';

                body += `<tr class="${rowClass}"><td><strong>${r}</strong></td>`;
                cols.forEach(c => {
                    const cell = result[r][c];
                    let val = aggType === 'count' ? cell.count : (aggType === 'avg' ? (cell.count > 0 ? cell.sum/cell.count : 0) : cell.sum);
                    rowSum += cell.sum;
                    rowCount += cell.count;
                    body += `<td>${formatVal(val, valFormat, aggType)}</td>`;
                });
                const rowTotal = aggType === 'count' ? rowCount : (aggType === 'avg' ? (rowCount > 0 ? rowSum/rowCount : 0) : rowSum);
                body += `<td><strong>${formatVal(rowTotal, valFormat, aggType)}</strong></td></tr>`;
                grandSum += rowSum;
                grandCount += rowCount;
            });

            body += `<tr class="total-row"><td><strong>TOTAL</strong></td>`;
            cols.forEach(c => {
                const val = aggType === 'count' ? colTotals[c].count : (aggType === 'avg' ? (colTotals[c].count > 0 ? colTotals[c].sum/colTotals[c].count : 0) : colTotals[c].sum);
                body += `<td>${formatVal(val, valFormat, aggType)}</td>`;
            });
            const grandTotal = aggType === 'count' ? grandCount : (aggType === 'avg' ? (grandCount > 0 ? grandSum/grandCount : 0) : grandSum);
            body += `<td><strong>${formatVal(grandTotal, valFormat, aggType)}</strong></td></tr>`;
        }

        table.querySelector('tbody').innerHTML = body;
    }

    function formatVal(v, format, agg) {
        if (!v || v === 0) return '<span style="color:#666">0</span>';

        if (format === 'currency') {
            return '$' + formatWithKL(v);
        }
        if (format === 'miles') {
            return formatWithKL(v);
        }
        if (agg === 'avg') {
            return Math.round(v).toLocaleString('en-IN');
        }
        return Math.round(v).toLocaleString('en-IN');
    }

    function updateAllTables() {
        const monthlyData = getFilteredData('monthly');
        const weeklyData = getFilteredData('weekly');

        renderTable('tableShipperMonthly', pivot(monthlyData, 'shipper_size', 'month', 'cost_saved', 'sum'), 'M', 'currency', 'Shipper Size');
        renderTable('tableShipperWeekly', pivot(weeklyData, 'shipper_size', 'week', 'cost_saved', 'sum'), 'W', 'currency', 'Shipper Size');

        renderTable('tableProgramMonthly', pivot(monthlyData, 'program_type', 'month', 'cost_saved', 'sum'), 'M', 'currency', 'Program Type');
        renderTable('tableProgramWeekly', pivot(weeklyData, 'program_type', 'week', 'deviation_id', 'count'), 'W', 'number', 'Program Type');

        renderTable('tableShiftMonthly', pivot(monthlyData, 'shift', 'month', 'deviation_id', 'count'), 'M', 'number', 'Shift');
        renderTable('tableShiftWeekly', pivot(weeklyData, 'shift', 'week', 'deviation_id', 'count'), 'W', 'number', 'Shift');

        const slMonthly = monthlyData.filter(d => d.resolver_id);
        const slWeekly = weeklyData.filter(d => d.resolver_id);
        renderTable('tableSLMonthly', pivot(slMonthly, 'resolver_id', 'month', 'sl', 'avg'), 'M', 'number', 'Associate');
        renderTable('tableSLWeekly', pivot(slWeekly, 'resolver_id', 'week', 'sl', 'avg'), 'W', 'number', 'Associate');

        const last4Weeks = getLast4Data('weeks').filter(d => d.resolver_id);
        const last4Months = getLast4Data('months').filter(d => d.resolver_id);

        renderTable('tableCountWeeks', pivot(last4Weeks, 'resolver_id', 'week', 'deviation_id', 'count'), 'W', 'number', 'Associate');
        renderTable('tableCountMonths', pivot(last4Months, 'resolver_id', 'month', 'deviation_id', 'count'), 'M', 'number', 'Associate');

        renderTable('tableCostWeeks', pivot(last4Weeks, 'resolver_id', 'week', 'cost_saved', 'sum'), 'W', 'currency', 'Associate');
        renderTable('tableCostMonths', pivot(last4Months, 'resolver_id', 'month', 'cost_saved', 'sum'), 'M', 'currency', 'Associate');

        renderTable('tableMilesWeeks', pivot(last4Weeks, 'resolver_id', 'week', 'miles_saved', 'sum'), 'W', 'miles', 'Associate');
        renderTable('tableMilesMonths', pivot(last4Months, 'resolver_id', 'month', 'miles_saved', 'sum'), 'M', 'miles', 'Associate');
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>

</html>
